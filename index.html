<script>
// This is the single function that runs everything.
function calculatePerformance() {
  
  // --- 1. READ INPUTS ---
  const hours = parseFloat(document.getElementById("sleepHours").value);
  const role = parseInt(document.getElementById("role").value);
  const spec = parseInt(document.getElementById("specialty").value);

  // --- 2. DEFINE MODEL PARAMETERS (from Stata simulation) ---
  const p = {
    rt: 32, clin: -3, diag: -2.5, err: 0.11, burn: 0.25, mood: -2, lap_quad: 0.05
  };
  const lapmaxFixed = 30; // Pre-calculated 99th percentile for stable scaling

  // --- 3. CALCULATE METRICS FOR BOTH ACTUAL & BASELINE STATES ---
  const getMetrics = (currentHours) => {
    const debt = Math.max(0, 8 - currentHours);
    const debtSq = debt * debt;

    // Calculate raw scores
    const raw_rt = 280 + (p.rt + (role === 3 ? -2 : 0) + (spec === 1 ? 4 : 0)) * debt + 1 * debtSq;
    const raw_clin = 95 + (p.clin + (spec === 2 ? -1 : 0) + (role === 1 ? -0.5 : 0) + (role === 3 ? 1 : 0)) * debt - 0.2 * debtSq;
    const raw_diag = 90 + (p.diag + (role === 1 ? -0.5 : 0) + (role === 3 ? 0.5 : 0)) * debt - 0.3 * debtSq;
    const raw_laps_lambda = Math.exp(-1 + 0.25 * debt + p.lap_quad * debtSq);
    const raw_err_prob = 1 / (1 + Math.exp(-(-2.94 + p.err * debt + 0.01 * debtSq)));
    const raw_burn_prob = 1 / (1 + Math.exp(-(-1.95 + p.burn * debt)));

    // Normalize scores for the composite
    let norm_rt = (600 - raw_rt) / (600 - 200) * 100;
    let norm_clin = (raw_clin - 60) / (100 - 60) * 100;
    let norm_diag = (raw_diag - 70) / 30 * 100;
    let norm_laps = (lapmaxFixed - raw_laps_lambda) / lapmaxFixed * 100;
    
    norm_rt = Math.max(0, Math.min(100, norm_rt));
    norm_clin = Math.max(0, Math.min(100, norm_clin));
    norm_diag = Math.max(0, Math.min(100, norm_diag));
    norm_laps = Math.max(0, Math.min(100, norm_laps));

    const overall_score = (norm_clin + norm_rt + norm_laps + norm_diag) / 4;

    // *** CHANGE 1: Return the raw scores for clin and diag as well ***
    return { 
      overall: overall_score, 
      clin: norm_clin, raw_clin: raw_clin, 
      rt: raw_rt, 
      diag: norm_diag, raw_diag: raw_diag, 
      lapses: raw_laps_lambda, 
      error: raw_err_prob, 
      burnout: raw_burn_prob 
    };
  };

  const actual = getMetrics(hours);
  const baseline = getMetrics(8);

  // --- 4. UPDATE THE DISPLAY ---
  
  // A. Handle the Overall Performance score
  const overallPercent = (actual.overall / baseline.overall) * 100;
  const overallDeficitVal = overallPercent - 100;
  
  document.getElementById("overallPerformance").innerText = overallPercent.toFixed(1) + "%";
  
  let overallDeficitHTML = `(Rested Baseline)`;
  if (Math.abs(overallDeficitVal) > 0.1) {
    overallDeficitHTML = `(<span class="deficit-red">${overallDeficitVal.toFixed(1)} pp from baseline</span>)`;
  }
  document.getElementById("overallDeficit").innerHTML = overallDeficitHTML;

  // B. Handle the individual component metrics
  const formatDeficit = (actualVal, baseVal, lowerIsBetter = false, isProb = false) => {
    let diff = actualVal - baseVal;
    if (isProb) diff *= 100;
    
    if (Math.abs(diff) < (isProb ? 0.1 : 0.05)) return `(Baseline)`;
    
    const sign = diff > 0 ? "+" : "";
    const cls = (lowerIsBetter && diff > 0) || (!lowerIsBetter && diff < 0) ? "deficit-red" : "deficit-green";
    
    let unit = " pts";
    if (isProb) unit = " pp";
    else if (lowerIsBetter) unit = " ms";
        
    return `(<span class="${cls}">${sign}${diff.toFixed(1)}${unit}</span>)`;
  };

  // *** CHANGE 2: Update display to use raw_clin and raw_diag ***
  document.getElementById("clinicalOut").innerText = actual.raw_clin.toFixed(1) + "/100";
  document.getElementById("clinicalDef").innerHTML = formatDeficit(actual.raw_clin, baseline.raw_clin);
  
  document.getElementById("reactionOut").innerText = actual.rt.toFixed(0) + " ms";
  document.getElementById("reactionDef").innerHTML = formatDeficit(actual.rt, baseline.rt, true);

  document.getElementById("diagOut").innerText = actual.raw_diag.toFixed(1) + "/100";
  document.getElementById("diagDef").innerHTML = formatDeficit(actual.raw_diag, baseline.raw_diag);

  document.getElementById("lapsesOut").innerText = actual.lapses.toFixed(1);
  document.getElementById("lapsesDef").innerHTML = formatDeficit(actual.lapses, baseline.lapses, true);

  document.getElementById("errorOut").innerText = (actual.error * 100).toFixed(1) + "%";
  document.getElementById("errorDef").innerHTML = formatDeficit(actual.error, baseline.error, true, true);
  
  document.getElementById("burnOut").innerText = (actual.burnout * 100).toFixed(1) + "%";
  document.getElementById("burnDef").innerHTML = formatDeficit(actual.burnout, baseline.burnout, true, true);

  // C. Cognitive state equivalence
  let eq = "Comparable to a rested, sober state";
  if (actual.rt >= 360 && actual.rt < 450) eq = "≈BAC 0.05% (Minor Impairment)";
  if (actual.rt >= 450 && actual.rt < 500) eq = "≈BAC 0.08% (Legally Impaired for Driving)";
  if (actual.rt >= 500) eq = ">BAC 0.10% (Severe Impairment)";
  document.getElementById("equivalenceOut").innerText = eq;
}

// Run the calculation once on page load.
window.onload = calculatePerformance;
</script>
