<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Physician Performance & Safety Calculator</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         background: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
  .container { width: 100%; max-width: 1000px; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
  .header { background: #003366; color: #fff; padding: 25px; text-align: center; }
  .header h1 { margin: 0; font-size: 1.8em; }
  .calculator-body { display: flex; flex-wrap: wrap; padding: 25px; }
  .inputs { width: 100%; padding-bottom: 25px; border-bottom: 1px solid #e0e0e0; margin-bottom: 25px; }
  @media (min-width: 600px) { .inputs { width: 35%; border-bottom: none; border-right: 1px solid #e0e0e0; padding-right: 25px; margin-bottom: 0; } }
  .outputs { width: 100%; }
  @media (min-width: 600px) { .outputs { width: 65%; padding-left: 25px; } }
  .input-group { margin-bottom: 20px; }
  .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
  .input-group input, .input-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; }
  .output-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
  .output-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center; }
  .output-card h3 { margin: 0 0 8px; font-size: 1em; color: #003366; }
  .output-value { font-size: 1.6em; font-weight: 700; color: #0056b3; }
  .deficit { font-size: 0.9em; margin-top: 4px; }
  .deficit-red { color: #d93025; font-weight: 600; }
  .deficit-green { color: #1e8e3e; font-weight: 600; }
  .summary-card { grid-column: 1 / -1; }
  .overall-card { background: #e6f7ff; border-color: #91d5ff; }
  .overall-card .output-value { color: #003366; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Physician Performance & Safety Calculator</h1>
    <p style="margin: 5px 0 0; opacity: 0.9;">Deficit values are relative to a well-rested (8h sleep) baseline.</p>
  </div>
  <div class="calculator-body">
    <div class="inputs">
      <h2>Your Inputs</h2>
      <div class="input-group">
        <label for="sleepHours">Hours of Sleep</label>
        <input type="number" id="sleepHours" value="5.8" min="0" max="9" step="0.1" oninput="calculatePerformance()">
      </div>
      <div class="input-group">
        <label for="role">Role</label>
        <select id="role" onchange="calculatePerformance()">
          <option value="1">Student</option>
          <option value="2" selected>Resident</option>
          <option value="3">Attending</option>
        </select>
      </div>
      <div class="input-group">
        <label for="specialty">Specialty</label>
        <select id="specialty" onchange="calculatePerformance()">
          <option value="1">Emergency</option>
          <option value="2">Surgery</option>
          <option value="3" selected>Internal Med</option>
          <option value="4">Psychiatry</option>
        </select>
      </div>
    </div>
    <div class="outputs">
      <h2>Predicted Performance</h2>
      <div class="output-card summary-card overall-card">
        <h3>Overall Performance Score</h3>
        <div class="output-value" id="overallPerformance"></div>
        <div class="deficit" id="overallDeficit"></div>
      </div>
      <div class="output-grid">
        <div class="output-card"><h3>Clinical Skill</h3><div class="output-value" id="clinicalOut"></div><div class="deficit" id="clinicalDef"></div></div>
        <div class="output-card"><h3>Reaction Time</h3><div class="output-value" id="reactionOut"></div><div class="deficit" id="reactionDef"></div></div>
        <div class="output-card"><h3>Diagnostic Accuracy</h3><div class="output-value" id="diagOut"></div><div class="deficit" id="diagDef"></div></div>
        <div class="output-card"><h3>Attentional Lapses</h3><div class="output-value" id="lapsesOut"></div><div class="deficit" id="lapsesDef"></div></div>
        <div class="output-card"><h3>Error Risk</h3><div class="output-value" id="errorOut"></div><div class="deficit" id="errorDef"></div></div>
        <div class="output-card"><h3>Burnout Risk</h3><div class="output-value" id="burnOut"></div><div class="deficit" id="burnDef"></div></div>
      </div>
       <div class="output-card summary-card" style="margin-top: 15px;">
        <h3>Cognitive State Equivalent</h3>
        <div id="equivalenceOut" style="font-weight:600; font-size: 1.1em; color: #d93025;"></div>
      </div>
    </div>
  </div>
</div>

<script>
// This is the single function that runs everything.
function calculatePerformance() {
  
  // --- 1. READ INPUTS ---
  const hours = parseFloat(document.getElementById("sleepHours").value);
  const role = parseInt(document.getElementById("role").value);
  const spec = parseInt(document.getElementById("specialty").value);

  // --- 2. DEFINE MODEL PARAMETERS ---
  const p = {
    rt: 32, clin: -3, diag: -2.5, err: 0.11, burn: 0.25, mood: -2, lap_quad: 0.05
  };
  const lapmaxFixed = 30; // Pre-calculated 99th percentile for stable scaling

  // --- 3. CALCULATE METRICS FOR BOTH ACTUAL & BASELINE STATES ---
  // This helper function contains all the core math.
  const getMetrics = (currentHours) => {
    const debt = Math.max(0, 8 - currentHours);
    const debtSq = debt * debt;

    // Calculate raw scores
    const raw_rt = 280 + (p.rt + (role === 3 ? -2 : 0) + (spec === 1 ? 4 : 0)) * debt + 1 * debtSq;
    const raw_clin = 95 + (p.clin + (spec === 2 ? -1 : 0) + (role === 1 ? -0.5 : 0) + (role === 3 ? 1 : 0)) * debt - 0.2 * debtSq;
    const raw_diag = 90 + (p.diag + (role === 1 ? -0.5 : 0) + (role === 3 ? 0.5 : 0)) * debt - 0.3 * debtSq;
    const raw_laps_lambda = Math.exp(-1 + 0.25 * debt + p.lap_quad * debtSq);
    const raw_err_prob = 1 / (1 + Math.exp(-(-2.94 + p.err * debt + 0.01 * debtSq)));
    const raw_burn_prob = 1 / (1 + Math.exp(-(-1.95 + p.burn * debt)));

    // Normalize scores
    let norm_rt = (600 - raw_rt) / (600 - 200) * 100;
    let norm_clin = (raw_clin - 60) / (100 - 60) * 100;
    let norm_diag = (raw_diag - 70) / 30 * 100;
    let norm_laps = (lapmaxFixed - raw_laps_lambda) / lapmaxFixed * 100;
    
    // Bound scores between 0 and 100
    norm_rt = Math.max(0, Math.min(100, norm_rt));
    norm_clin = Math.max(0, Math.min(100, norm_clin));
    norm_diag = Math.max(0, Math.min(100, norm_diag));
    norm_laps = Math.max(0, Math.min(100, norm_laps));

    const overall_score = (norm_clin + norm_rt + norm_laps + norm_diag) / 4;

    return { overall: overall_score, clin: norm_clin, rt: raw_rt, diag: norm_diag, lapses: raw_laps_lambda, error: raw_err_prob, burnout: raw_burn_prob };
  };

  const actual = getMetrics(hours);
  const baseline = getMetrics(8); // Baseline is always 8 hours of sleep

  // --- 4. UPDATE THE DISPLAY ---
  const formatDeficit = (actualVal, baseVal, lowerIsBetter = false, isProb = false) => {
    let diff = actualVal - baseVal;
    if (isProb) diff *= 100; // Convert probability difference to percentage points
    
    if (Math.abs(diff) < (isProb ? 0.1 : 0.05)) return `(Baseline)`;
    
    const sign = diff > 0 ? "+" : "";
    const cls = (lowerIsBetter && diff > 0) || (!lowerIsBetter && diff < 0) ? "deficit-red" : "deficit-green";
    
    let unit = " pts";
    if (isProb) unit = " pp"; // percentage points
    else if (lowerIsBetter && actualVal < 1) unit = "";
    else if (lowerIsBetter) unit = " ms";
        
    return `(<span class="${cls}">${sign}${diff.toFixed(1)}${unit}</span>)`;
  };

  document.getElementById("overallPerformance").innerText = actual.overall.toFixed(1);
  document.getElementById("overallDeficit").innerHTML = formatDeficit(actual.overall, baseline.overall);

  document.getElementById("clinicalOut").innerText = actual.clin.toFixed(1);
  document.getElementById("clinicalDef").innerHTML = formatDeficit(actual.clin, baseline.clin);
  
  document.getElementById("reactionOut").innerText = actual.rt.toFixed(0) + " ms";
  document.getElementById("reactionDef").innerHTML = formatDeficit(actual.rt, baseline.rt, true);

  document.getElementById("diagOut").innerText = actual.diag.toFixed(1);
  document.getElementById("diagDef").innerHTML = formatDeficit(actual.diag, baseline.diag);

  document.getElementById("lapsesOut").innerText = actual.lapses.toFixed(1);
  document.getElementById("lapsesDef").innerHTML = formatDeficit(actual.lapses, baseline.lapses, true);

  document.getElementById("errorOut").innerText = (actual.error * 100).toFixed(1) + "%";
  document.getElementById("errorDef").innerHTML = formatDeficit(actual.error, baseline.error, true, true);
  
  document.getElementById("burnOut").innerText = (actual.burnout * 100).toFixed(1) + "%";
  document.getElementById("burnDef").innerHTML = formatDeficit(actual.burnout, baseline.burnout, true, true);

  // Cognitive state equivalence
  let eq = "Comparable to a rested, sober state";
  if (actual.rt >= 360 && actual.rt < 450) eq = "≈BAC 0.05% (Minor Impairment)";
  if (actual.rt >= 450 && actual.rt < 500) eq = "≈BAC 0.08% (Legally Impaired for Driving)";
  if (actual.rt >= 500) eq = ">BAC 0.10% (Severe Impairment)";
  document.getElementById("equivalenceOut").innerText = eq;
}

// Run the calculation once on page load.
window.onload = calculatePerformance;
</script>
</body>
</html>
