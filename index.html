function calculatePerformance() {
    const sleepHours = parseFloat(document.getElementById('sleepHours').value);
    const role = document.getElementById('role').value;
    
    if (!sleepHours || sleepHours < 0 || sleepHours > 12) {
        alert('Please enter a valid sleep duration between 0 and 12 hours.');
        return;
    }
    
    if (!role) {
        alert('Please select your role/experience level.');
        return;
    }
    
    // Calculate sleep debt (capped at 0 for >8 hours)
    const sleepDebt = Math.max(0, 8 - sleepHours);
    
    // Role modifiers (from your model)
    let rtModifier = 0;
    let diagModifier = 0;
    let clinModifier = 0;
    
    if (role === 'resident') {
        rtModifier = 2;
    } else if (role === 'attending') {
        rtModifier = -2;
        diagModifier = -0.5;
        clinModifier = -1.0;
    } else if (role === 'student') {
        diagModifier = 0.5;
        clinModifier = 0.5;
    }
    
    // Calculate raw performance metrics (from your model)
    const rt_current = 280 + (32 + rtModifier) * sleepDebt + 1 * sleepDebt * sleepDebt;
    const diag_current = 90 - (2.5 + diagModifier) * sleepDebt - 0.3 * sleepDebt * sleepDebt;
    const clin_current = 95 - (3 + clinModifier) * sleepDebt - 0.2 * sleepDebt * sleepDebt;
    const hand_current = 90 - 2 * sleepDebt - 0.2 * sleepDebt * sleepDebt;
    
    // Calculate BASELINE values (at 8 hours sleep, debt = 0)
    const rt_baseline = 280 + (32 + rtModifier) * 0 + 1 * 0 * 0;  // = 280
    const diag_baseline = 90 - (2.5 + diagModifier) * 0 - 0.3 * 0 * 0;  // = 90
    const clin_baseline = 95 - (3 + clinModifier) * 0 - 0.2 * 0 * 0;   // = 95
    const hand_baseline = 90 - 2 * 0 - 0.2 * 0 * 0;  // = 90
    
    // Simulate attention lapses (simplified)
    const laps_current = Math.exp(-1 + 0.25 * sleepDebt + 0.05 * sleepDebt * sleepDebt);
    const laps_baseline = Math.exp(-1 + 0.25 * 0 + 0.05 * 0 * 0);  // = exp(-1) â‰ˆ 0.37
    
    // Calculate percentage of baseline (100% = baseline performance)
    // For RT: lower is better, so we invert the calculation
    const norm_rt = Math.max(0, Math.min(120, (rt_baseline / rt_current) * 100));
    const norm_clin = Math.max(0, Math.min(120, (clin_current / clin_baseline) * 100));
    const norm_diag = Math.max(0, Math.min(120, (diag_current / diag_baseline) * 100));
    const norm_hand = Math.max(0, Math.min(120, (hand_current / hand_baseline) * 100));
    const norm_laps = Math.max(0, Math.min(120, (laps_baseline / laps_current) * 100));
    
    // Calculate overall performance (your base composite weights)
    const overall = 0.40 * norm_clin + 0.25 * norm_rt + 0.15 * norm_laps + 0.10 * norm_diag + 0.10 * norm_hand;
    
    // Display results
    displayResults(overall, norm_rt, norm_clin, norm_diag, norm_laps, norm_hand, sleepHours);
}

function displayResults(overall, rt, clin, diag, laps, hand, sleepHours) {
    document.getElementById('results').classList.remove('hidden');
    
    // Overall score
    const scoreElement = document.getElementById('overallScore');
    const scoreValue = document.getElementById('scoreValue');
    const scoreDescription = document.getElementById('scoreDescription');
    
    scoreValue.textContent = Math.round(overall) + '%';
    
    // Color coding and descriptions
    if (overall >= 95) {
        scoreElement.className = 'overall-score score-excellent';
        scoreDescription.textContent = 'Optimal Performance';
    } else if (overall >= 85) {
        scoreElement.className = 'overall-score score-good';
        scoreDescription.textContent = 'Good Performance';
    } else if (overall >= 70) {
        scoreElement.className = 'overall-score score-concerning';
        scoreDescription.textContent = 'Impaired Performance';
    } else {
        scoreElement.className = 'overall-score score-critical';
        scoreDescription.textContent = 'Severely Impaired';
    }
    
    // Individual metrics with color coding
    const metrics = [
        {id: 'rtScore', value: rt},
        {id: 'clinScore', value: clin},
        {id: 'diagScore', value: diag},
        {id: 'lapsScore', value: laps},
        {id: 'handScore', value: hand}
    ];
    
    metrics.forEach(metric => {
        const element = document.getElementById(metric.id);
        element.textContent = Math.round(metric.value) + '%';
        
        // Color coding based on performance vs baseline
        if (metric.value >= 100) {
            element.className = 'metric-value above-baseline';
        } else if (metric.value >= 90) {
            element.className = 'metric-value';
        } else {
            element.className = 'metric-value below-baseline';
        }
    });
    
    // Warning for low performance
    const warningBox = document.getElementById('warningBox');
    if (overall < 85 || sleepHours < 6) {
        warningBox.classList.remove('hidden');
    } else {
        warningBox.classList.add('hidden');
    }
}
